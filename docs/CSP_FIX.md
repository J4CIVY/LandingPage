# Content Security Policy (CSP) Fix Documentation

## Problem

When accessing the production website at bskmt.com, the browser console showed the following CSP violation error:

```
Refused to execute inline script because it violates the following Content Security Policy directive: "script-src 'self' 'nonce-...' 'strict-dynamic' ..."
```

This error occurred because third-party scripts (reCAPTCHA and Bold Checkout) were being loaded dynamically without the proper CSP nonce attribute, causing them to be blocked by the Content Security Policy.

## Root Cause

The issue was caused by:

1. **reCAPTCHA Integration**: The `react-google-recaptcha-v3` library was loading the Google reCAPTCHA script without respecting the CSP nonce, causing inline script execution to be blocked.

2. **Bold Checkout Integration**: The Bold payment checkout script was being dynamically injected without the CSP nonce attribute.

3. **Missing Nonce Accessibility**: Client-side code didn't have easy access to the CSP nonce generated by the middleware.

## Solution

### Changes Made

#### 1. Enhanced CSP Nonce Accessibility (`app/layout.tsx`)

Added a meta tag to make the CSP nonce accessible to client-side JavaScript:

```tsx
<meta property="csp-nonce" content={nonce} />
```

This allows client-side components to retrieve the nonce and apply it to dynamically created scripts.

#### 2. Custom reCAPTCHA Implementation (`lib/recaptcha-client.tsx`)

Replaced the third-party library's script loading with a custom implementation that:

- Retrieves the CSP nonce from the document
- Manually loads the reCAPTCHA script with the nonce attribute
- Creates a custom React Context for reCAPTCHA functionality
- Maintains backward compatibility with existing code

Key features:
```tsx
// Get nonce from meta tag or existing nonce attribute
const nonce = getCSPNonce();

// Apply nonce to script element
if (nonce) {
  script.setAttribute('nonce', nonce);
}
```

#### 3. Bold Checkout Script Loading (`components/shared/BoldCheckoutButton.tsx`)

Updated the Bold Checkout button component to:

- Retrieve the CSP nonce using the same `getCSPNonce()` function
- Apply the nonce to dynamically created script elements
- Ensure CSP compliance while loading payment scripts

### Files Modified

1. **`app/layout.tsx`**
   - Added CSP nonce meta tag for client-side access

2. **`lib/recaptcha-client.tsx`**
   - Replaced third-party library's script loader with custom CSP-compliant implementation
   - Added `getCSPNonce()` utility function
   - Created custom React Context for reCAPTCHA
   - Maintained backward compatibility with existing `useRecaptcha()` hook

3. **`components/shared/BoldCheckoutButton.tsx`**
   - Added `getCSPNonce()` utility function
   - Updated script creation to include nonce attribute
   - Ensured CSP compliance for payment script loading

## How It Works

### CSP Nonce Flow

1. **Server-Side (Middleware)**:
   - Generates a unique cryptographic nonce for each request
   - Sets the nonce in the `x-nonce` header
   - Applies the nonce to the CSP header

2. **Server-Side Rendering (Layout)**:
   - Retrieves the nonce from headers
   - Injects nonce into inline `<style>` tags
   - Adds a meta tag with the nonce for client-side access

3. **Client-Side (Dynamic Scripts)**:
   - Components retrieve the nonce from the meta tag or existing elements
   - Apply the nonce to dynamically created script elements
   - Scripts execute successfully without CSP violations

### Nonce Retrieval Function

```typescript
function getCSPNonce(): string | null {
  if (typeof document === 'undefined') return null;
  
  // Try to get nonce from an existing inline style with nonce attribute
  const styleWithNonce = document.querySelector('style[nonce]');
  if (styleWithNonce) {
    return styleWithNonce.getAttribute('nonce');
  }
  
  // Try to get from meta tag if set
  const nonceMeta = document.querySelector('meta[property="csp-nonce"]');
  if (nonceMeta) {
    return nonceMeta.getAttribute('content');
  }
  
  return null;
}
```

## Deployment Instructions

### 1. Prerequisites

Ensure your environment variables are set:
- `NEXT_PUBLIC_RECAPTCHA_SITE_KEY` - Your Google reCAPTCHA v3 site key
- Bold Checkout API keys (as configured in your environment)

### 2. Testing Locally

```bash
# Install dependencies (if any new ones were added)
npm install

# Build the application
npm run build

# Run in production mode locally
npm start
```

### 3. Verify CSP Compliance

Open the browser console and check for:
- ✅ No CSP violation errors
- ✅ reCAPTCHA loads successfully
- ✅ Bold Checkout loads successfully
- ✅ All third-party scripts execute properly

### 4. Production Deployment

```bash
# Deploy to your production environment
# (Vercel, Netlify, or your hosting platform)

# For Vercel:
vercel --prod

# For other platforms:
# Push to your main branch or follow your deployment workflow
```

### 5. Post-Deployment Verification

1. Visit your production site: https://bskmt.com
2. Open browser DevTools (F12)
3. Go to the Console tab
4. Check for any CSP errors (there should be none)
5. Test functionality:
   - reCAPTCHA on forms (login, register, contact)
   - Bold Checkout on payment pages
   - All third-party integrations

## Security Benefits

### Before Fix
- ❌ CSP violations in production
- ❌ Inline scripts blocked
- ❌ Third-party scripts failing to load
- ❌ Degraded user experience

### After Fix
- ✅ Full CSP compliance
- ✅ Enhanced XSS protection
- ✅ All scripts load with proper authorization
- ✅ Better security posture
- ✅ Improved user experience

## Browser Compatibility

This solution works with:
- ✅ Chrome/Edge (all versions with CSP support)
- ✅ Firefox (all versions with CSP support)
- ✅ Safari (all versions with CSP support)
- ✅ Mobile browsers (iOS Safari, Chrome Mobile)

## Troubleshooting

### If CSP Errors Persist

1. **Clear Browser Cache**:
   - Hard refresh: Ctrl+F5 (Windows) or Cmd+Shift+R (Mac)
   - Clear all cached data

2. **Check Nonce Generation**:
   - Verify middleware is running: `middleware.ts`
   - Ensure nonce is being generated on each request
   - Check that the nonce is set in response headers

3. **Verify Meta Tag**:
   - View page source
   - Look for: `<meta property="csp-nonce" content="...">`
   - Ensure the nonce value matches the CSP header

4. **Check Console Logs**:
   - Look for reCAPTCHA loading messages
   - Check for Bold script loading messages
   - Verify no JavaScript errors

### If reCAPTCHA Doesn't Work

1. Verify `NEXT_PUBLIC_RECAPTCHA_SITE_KEY` is set
2. Check that the key is valid for your domain
3. Look for console warnings about reCAPTCHA
4. Ensure the script loaded: check Network tab for `api.js?render=...`

### If Bold Checkout Doesn't Work

1. Verify Bold API keys are configured
2. Check Bold script loading in Network tab
3. Look for console errors related to Bold
4. Ensure the checkout script URL is correct

## Additional Resources

- [Content Security Policy (CSP) - MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
- [CSP with nonces - web.dev](https://web.dev/strict-csp/)
- [Google reCAPTCHA v3](https://developers.google.com/recaptcha/docs/v3)

## Monitoring

After deployment, monitor:
- Browser console for CSP violations
- Error tracking (Sentry, etc.) for runtime errors
- User reports of functionality issues
- Payment completion rates (Bold Checkout)
- Form submission rates (reCAPTCHA)

## Future Improvements

Consider implementing:
- Automated CSP violation reporting endpoint
- CSP violation tracking in analytics
- Automated tests for CSP compliance
- Regular security audits

---

**Date**: October 25, 2025  
**Status**: ✅ Fixed and Tested  
**Impact**: High - Affects all users on production site
